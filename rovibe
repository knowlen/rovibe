#!/usr/bin/env bash
set -euo pipefail

SCRIPT="rovibe"
log()  { echo "[$SCRIPT] $*"; }
err()  { echo "[$SCRIPT] ERROR: $*" >&2; exit 1; }

ROVIBE_LIB="${ROVIBE_LIB:-/usr/local/lib/rovibe}"

usage() {
  cat <<'EOF'
Usage: rovibe <command> [args...]

Commands:
  create <username> [--profile <profile>]  Create an isolated agent identity
                                           Profiles: read-only, standard (default),
                                                     network-isolated
  delete <username>                        Delete an agent identity
  assign <agent> <project> [--role <role>] Assign agent to project
  unassign <agent> <project>               Remove agent's project assignment
  launch <agent> <project>                 Launch an agent session
  list [<agent>|<project>]                 List agents and assignment status
  allow <agent> <cmd> [<cmd> ...]          Allow agent to run commands
  restrict <agent> <cmd> [<cmd> ...]       Revoke agent's access to commands
  sync <project>                           Sync all mirrors for a project
  uninstall [--purge]                      Remove rovibe from the system
EOF
  exit 1
}

[[ $# -ge 1 ]] || usage

VERB="$1"; shift

case "$VERB" in
  create)
    exec "$ROVIBE_LIB/create-agent" "$@"
    ;;
  delete)
    exec "$ROVIBE_LIB/create-agent" "$@" --delete
    ;;
  assign)
    exec "$ROVIBE_LIB/assign" "$@"
    ;;
  unassign)
    exec "$ROVIBE_LIB/unassign" "$@"
    ;;
  launch)
    exec "$ROVIBE_LIB/launch" "$@"
    ;;
  list)
    exec "$ROVIBE_LIB/list" "$@"
    ;;
  allow)
    exec "$ROVIBE_LIB/allow" "$@"
    ;;
  restrict)
    exec "$ROVIBE_LIB/restrict" "$@"
    ;;
  sync)
    # Inline sync: find all agent mirrors for this project and sync them
    [[ $# -ge 1 ]] || err "sync requires a project directory"
    PROJECT_DIR="$1"; shift
    [[ -d "$PROJECT_DIR" ]] || err "Project directory does not exist: $PROJECT_DIR"
    if [[ $EUID -ne 0 ]]; then
      exec sudo "$0" sync "$PROJECT_DIR" "$@"
    fi
    PROJECT_DIR=$(realpath "$PROJECT_DIR")
    PROJECT_NAME=$(basename "$PROJECT_DIR")

    # Get agents group members
    if ! getent group agents >/dev/null 2>&1; then
      err "Group 'agents' does not exist"
    fi

    MEMBERS_LINE=$(getent group agents | cut -d: -f4)
    if [[ -z "$MEMBERS_LINE" ]]; then
      log "No members in 'agents' group."
      exit 0
    fi

    IFS=',' read -ra MEMBERS <<< "$MEMBERS_LINE"
    COUNT=0

    for user in "${MEMBERS[@]}"; do
      MIRROR="/home/$user/mirrors/$PROJECT_NAME"
      if [[ -d "$MIRROR" ]]; then
        log "Syncing mirror for $user..."
        "$ROVIBE_LIB/sync-mirror" "$PROJECT_DIR" "$MIRROR"
        COUNT=$((COUNT + 1))
      fi
    done

    log "Synced $COUNT mirror(s)."
    ;;
  uninstall)
    exec "$ROVIBE_LIB/uninstall.sh" "$@"
    ;;
  -h|--help|help)
    usage
    ;;
  *)
    usage
    ;;
esac

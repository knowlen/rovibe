#!/usr/bin/env bash
set -euo pipefail

SCRIPT="unassign"
log()  { echo "[$SCRIPT] $*"; }
err()  { echo "[$SCRIPT] ERROR: $*" >&2; exit 1; }

usage() {
  cat <<'EOF'
Usage: unassign <agent> <project> [--purge-scratch]
       (args are order-independent, inferred by type)

Removes an agent's assignment for a project:
  1. Removes symlinks from the mirror
  2. Removes .claude/ dir and .scratch symlink from mirror
  3. Removes empty directories bottom-up
  4. Removes the mirror root directory

Options:
  --purge-scratch   Also remove the agent's .scratch/reviews/<agent> dir from the project
EOF
  exit 1
}

# --- Parse arguments ---
AGENT_USER=""
PROJECT_DIR=""
PURGE_SCRATCH=false
ORIG_ARGS=("$@")

operator_home=$(getent passwd "${SUDO_USER:-$USER}" | cut -d: -f6)

while [[ $# -gt 0 ]]; do
  case "$1" in
    --purge-scratch)
      PURGE_SCRATCH=true
      shift
      ;;
    -h|--help)
      usage
      ;;
    *)
      # Classify bare args by type, not position.
      # Only ~/... is expanded; ~user/... is not supported (use absolute paths)
      if [[ "$1" == /* || "$1" == ~* || "$1" == ./* || "$1" == */* ]] \
         || [[ -d "$1" ]]; then
        [[ -z "$PROJECT_DIR" ]] || err "ambiguous: two paths provided"
        PROJECT_DIR="$1"
        [[ "$PROJECT_DIR" == ~/* || "$PROJECT_DIR" == "~" ]] && \
          PROJECT_DIR="${PROJECT_DIR/#\~/$operator_home}"
      elif id "$1" >/dev/null 2>&1 && id -nG "$1" 2>/dev/null | grep -qw agents; then
        [[ -z "$AGENT_USER" ]] || err "ambiguous: two agent users provided"
        AGENT_USER="$1"
      else
        err "cannot infer argument: $1"
      fi
      shift
      ;;
  esac
done

[[ -n "$AGENT_USER" ]] || err "Missing agent username"
[[ -n "$PROJECT_DIR" ]] || err "Missing project directory"

if [[ $EUID -ne 0 ]]; then
  exec sudo "$0" "${ORIG_ARGS[@]}"
fi

PROJECT_DIR=$(realpath "$PROJECT_DIR")
PROJECT_NAME=$(basename "$PROJECT_DIR")
MIRROR_DIR="/home/$AGENT_USER/mirrors/$PROJECT_NAME"

if [[ ! -d "$MIRROR_DIR" ]]; then
  log "Mirror does not exist at $MIRROR_DIR, nothing to unassign."
  exit 0
fi

# --- Step 1: Remove symlinks in mirror ---
log "Removing symlinks from mirror..."
while IFS= read -r -d '' link; do
  rm "$link"
done < <(find "$MIRROR_DIR" -type l -print0 2>/dev/null)

# --- Step 2: Remove .claude directory from mirror ---
if [[ -d "$MIRROR_DIR/.claude" ]]; then
  log "Removing .claude/ from mirror..."
  rm -rf "$MIRROR_DIR/.claude"
fi

# --- Step 3: Remove empty directories bottom-up ---
log "Removing empty directories..."
# Find empty dirs deepest-first and remove them
while IFS= read -r -d '' dir; do
  rmdir "$dir" 2>/dev/null || true
done < <(find "$MIRROR_DIR" -mindepth 1 -type d -empty -print0 2>/dev/null | sort -rz)

# --- Step 4: Remove mirror root ---
if [[ -d "$MIRROR_DIR" ]]; then
  # One more pass, there may be nested empties now
  find "$MIRROR_DIR" -mindepth 1 -type d -empty -delete 2>/dev/null || true
  rmdir "$MIRROR_DIR" 2>/dev/null || log "WARN: Mirror dir not empty, not removed: $MIRROR_DIR"
fi

# --- Step 5: Optionally purge scratch ---
if $PURGE_SCRATCH; then
  SCRATCH_DIR="$PROJECT_DIR/.scratch/reviews/$AGENT_USER"
  if [[ -d "$SCRATCH_DIR" ]]; then
    log "Purging scratch directory: $SCRATCH_DIR"
    sudo rm -rf "$SCRATCH_DIR"
  fi
fi

log "Agent '$AGENT_USER' unassigned from '$PROJECT_NAME'."

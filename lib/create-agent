#!/usr/bin/env bash
set -euo pipefail

SCRIPT="create-agent"
log()  { echo "[$SCRIPT] $*"; }
err()  { echo "[$SCRIPT] ERROR: $*" >&2; exit 1; }

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/apparmor"

usage() {
  cat <<'EOF'
Usage: create-agent <username> [--profile <profile>] [--delete]

Creates (or deletes) an OS-level isolated agent identity.

Arguments:
  username                Agent username (e.g. agent.ro)
  --profile <profile>     Permission profile (default: standard)
                          Profiles: read-only, standard, network-isolated
  --delete                Remove the agent user and its home directory

The agent gets:
  - A restricted PATH (/opt/rovibe/<username>/bin only)
  - Membership in the 'agents' group
  - A home directory at /home/<username>
  - Allowlisted symlinks in /opt/rovibe/<username>/bin/
EOF
  exit 1
}

# --- Profile command sets ---
PROFILE_READ_ONLY=(
  bash sh
  cat echo cut grep sed awk tr head tail wc sort uniq tee
  printf expr seq strings
  ls pwd stat file find du df
  basename dirname realpath readlink
  lsblk lscpu lsmem
  ps id whoami uptime free
  diff cmp md5sum sha256sum
  true false sleep
  jq xargs
  date uname
)

PROFILE_NETWORK_ISOLATED=(
  bash sh
  cat echo cut grep sed awk tr head tail wc sort uniq tee
  printf expr seq strings
  ls pwd stat file find du df
  basename dirname realpath readlink
  lsblk lscpu lsmem
  ps id whoami uptime free
  diff cmp md5sum sha256sum
  true false sleep
  jq xargs
  date uname
  tar zip unzip bzip2 gzip xz zstd
  vim nano
  ping ss lsof
  python3
  touch cp mkdir mktemp rmdir ln
  more less which
  env envsubst
)

PROFILE_STANDARD=(
  bash sh
  cat echo cut grep sed awk tr head tail wc sort uniq tee
  printf expr seq strings
  ls pwd stat file find du df
  basename dirname realpath readlink
  lsblk lscpu lsmem
  ps id whoami uptime free
  diff cmp md5sum sha256sum
  true false sleep
  jq xargs
  date uname
  tar zip unzip bzip2 gzip xz zstd
  vim nano
  ping ss lsof
  curl wget
  git
  python3
  touch cp mkdir mktemp rmdir ln
  more less which
  env envsubst
)


create_agent() {
  local username="$1"
  local home="/home/$username"
  local os
  os=$(uname -s)

  # Validate and select profile
  case "$PROFILE" in
    read-only|standard|network-isolated) ;;
    *) err "Unknown profile: '$PROFILE'. Valid: read-only, standard, network-isolated" ;;
  esac

  local ALLOWLIST
  case "$PROFILE" in
    read-only)        ALLOWLIST=("${PROFILE_READ_ONLY[@]}") ;;
    network-isolated) ALLOWLIST=("${PROFILE_NETWORK_ISOLATED[@]}") ;;
    standard)         ALLOWLIST=("${PROFILE_STANDARD[@]}") ;;
  esac

  # Conditionally add node if Claude is not a native binary
  CLAUDE_BIN=""
  [[ -n "${SUDO_USER:-}" ]] && \
    CLAUDE_BIN=$(sudo -u "$SUDO_USER" bash -c 'command -v claude' 2>/dev/null || true)
  [[ -z "$CLAUDE_BIN" && -n "${SUDO_USER:-}" && \
     -x "/home/$SUDO_USER/.claude/local/claude" ]] && \
    CLAUDE_BIN="/home/$SUDO_USER/.claude/local/claude"
  if [[ -n "$CLAUDE_BIN" ]] && \
     ! file "$CLAUDE_BIN" | grep -q "ELF"; then
    ALLOWLIST+=(node)
    log "NOTE: non-native Claude detected, adding 'node' to allowlist"
    log "      Migrate to native installer to remove this requirement:"
    log "      https://code.claude.com/docs/en/setup"
  fi

  # Ensure agents group exists
  if ! getent group agents >/dev/null 2>&1; then
    log "Creating 'agents' group..."
    sudo groupadd agents
  fi

  # Create user (idempotent)
  if id "$username" >/dev/null 2>&1; then
    log "User '$username' already exists, ensuring group membership..."
  else
    log "Creating user '$username'..."
    case "$os" in
      Linux)
        sudo useradd -m -g agents -s /bin/bash "$username"
        ;;
      Darwin)
        # macOS user creation
        local last_id
        last_id=$(dscl . -list /Users UniqueID | awk '{print $2}' | sort -n | tail -1)
        local new_id=$((last_id + 1))
        sudo dscl . -create "/Users/$username"
        sudo dscl . -create "/Users/$username" UserShell /bin/bash
        sudo dscl . -create "/Users/$username" UniqueID "$new_id"
        sudo dscl . -create "/Users/$username" PrimaryGroupID "$(dscl . -read /Groups/agents PrimaryGroupID | awk '{print $2}')"
        sudo dscl . -create "/Users/$username" NFSHomeDirectory "$home"
        sudo mkdir -p "$home"
        sudo chown "$username":agents "$home"
        ;;
      *)
        err "Unsupported OS: $os"
        ;;
    esac
  fi

  # Make home traversable so agent can cd into it
  sudo chmod 711 "$home"

  # Ensure user is in agents group
  case "$os" in
    Linux)
      sudo usermod -aG agents "$username" 2>/dev/null || true
      ;;
    Darwin)
      sudo dseditgroup -o edit -a "$username" -t user agents 2>/dev/null || true
      ;;
  esac

  # Create per-agent bin directory
  local bin_dir="/opt/rovibe/$username/bin"
  sudo mkdir -p "$bin_dir"
  sudo chown root:agents "$bin_dir"
  sudo chmod 755 "$bin_dir"

  # Populate default allowlist
  local script_dir
  script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  "$script_dir/allow" "$username" "${ALLOWLIST[@]}"

  # Explicit call -- allow triggers generation too, but we call directly to
  # make the dependency clear and ensure the profile includes claude binary detection.
  if apparmor_available; then
    apparmor_generate_profile "$username"
    log "AppArmor profile generated: rovibe-$username"
  else
    log "WARN: AppArmor not available, execution sandboxing disabled"
  fi

  # Write profile metadata
  echo "$PROFILE" > "/opt/rovibe/$username/.rovibe-profile"
  chown root:agents "/opt/rovibe/$username/.rovibe-profile"
  chmod 644 "/opt/rovibe/$username/.rovibe-profile"

  # Write .bashrc with restricted PATH
  local bashrc="$home/.bashrc"
  log "Writing restricted .bashrc..."
  sudo tee "$bashrc" >/dev/null <<BASHRC
# rovibe agent shell, restricted PATH
export PATH="/opt/rovibe/$username/bin"

# Prevent user from resetting PATH
readonly PATH
BASHRC
  sudo chown "$username":agents "$bashrc"
  sudo chmod 644 "$bashrc"

  # Write .bash_profile that sources .bashrc (for login shells)
  local bash_profile="$home/.bash_profile"
  log "Writing .bash_profile..."
  sudo tee "$bash_profile" >/dev/null <<'PROFILE'
# rovibe agent login shell, source .bashrc for restricted PATH
if [[ -f "$HOME/.bashrc" ]]; then
  source "$HOME/.bashrc"
fi
PROFILE
  sudo chown "$username":agents "$bash_profile"
  sudo chmod 644 "$bash_profile"

  # Set limits.conf entry (Linux only), limit resource usage
  if [[ "$os" == "Linux" ]]; then
    sudo mkdir -p /etc/security/limits.d
    local limits_file="/etc/security/limits.d/$username.conf"
    if [[ ! -f "$limits_file" ]]; then
      log "Writing limits.conf..."
      sudo tee "$limits_file" >/dev/null <<LIMITS
# rovibe agent limits for $username
$username  hard  nproc   256
$username  hard  nofile  4096
LIMITS
    fi
  fi

  log "Agent '$username' created."
  log "Profile: $PROFILE"
  log "Home: $home"
  log "PATH: /opt/rovibe/$username/bin"
}

print_available_agents() {
  local members
  members=$(getent group agents 2>/dev/null | cut -d: -f4 | tr ',' '\n' \
            | grep -v '^$' | sed 's/^/  /')
  echo "Available agents:"
  if [[ -z "$members" ]]; then
    echo "  (none)"
  else
    echo "$members"
  fi
}

delete_agent() {
  local username="$1"
  local home="/home/$username"
  local os
  os=$(uname -s)

  if ! id "$username" >/dev/null 2>&1; then
    log "User '$username' does not exist, nothing to delete."
    return 0
  fi

  log "Deleting agent '$username'..."

  # Remove AppArmor profile before killing processes
  if apparmor_available; then
    apparmor_remove_profile "$username"
    log "Removed AppArmor profile: rovibe-$username"
  fi

  # Kill any running processes
  sudo pkill -u "$username" 2>/dev/null || true
  sleep 1

  case "$os" in
    Linux)
      sudo userdel -r "$username" 2>/dev/null || true
      ;;
    Darwin)
      sudo dscl . -delete "/Users/$username" 2>/dev/null || true
      sudo rm -rf "$home"
      ;;
  esac

  # Remove per-agent bin
  sudo rm -rf "/opt/rovibe/$username"

  # Remove limits.conf
  sudo rm -f "/etc/security/limits.d/$username.conf"

  log "Agent '$username' deleted."
}

# --- Main ---
[[ $# -lt 1 ]] && usage

if [[ $EUID -ne 0 ]]; then
  exec sudo "$0" "$@"
fi

USERNAME=""
DELETE_FLAG=false
PROFILE="standard"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --delete)
      DELETE_FLAG=true
      shift
      ;;
    --profile)
      [[ $# -ge 2 ]] || err "--profile requires a value"
      PROFILE="$2"
      shift 2
      ;;
    -h|--help)
      usage
      ;;
    *)
      if [[ -z "$USERNAME" ]]; then
        USERNAME="$1"
      else
        err "Unexpected argument: $1"
      fi
      shift
      ;;
  esac
done

if $DELETE_FLAG; then
  SCRIPT="rovibe"
  if [[ -z "$USERNAME" ]]; then
    echo "[rovibe] Error: missing argument" >&2
    echo "Usage: rovibe delete <agent>"
    print_available_agents
    exit 1
  fi
  if ! id "$USERNAME" >/dev/null 2>&1; then
    echo "[rovibe] Error: agent '$USERNAME' does not exist" >&2
    echo "Usage: rovibe delete <agent>"
    print_available_agents
    exit 1
  fi
  delete_agent "$USERNAME"
else
  [[ -n "$USERNAME" ]] || err "Missing username"
  create_agent "$USERNAME"
fi

#!/usr/bin/env bash
set -euo pipefail

SCRIPT="launch"
log()  { echo "[$SCRIPT] $*"; }
err()  { echo "[$SCRIPT] ERROR: $*" >&2; exit 1; }

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/apparmor"

usage() {
  cat <<'EOF'
Usage: launch <agent> <project> [--prompt-file <path>]
       (args are order-independent, inferred by type)

Launches an agent session:
  1. Runs sync-mirror to pick up any new files
  2. Starts fswatch watcher for live sync (if available)
  3. Launches claude as the agent user

Options:
  --prompt-file <path>   Pass prompt content via --print to Claude Code
EOF
  exit 1
}

# --- Parse arguments ---
AGENT_USER=""
PROJECT_DIR=""
PROMPT_FILE=""
ORIG_ARGS=("$@")

operator_home=$(getent passwd "${SUDO_USER:-$USER}" | cut -d: -f6)

while [[ $# -gt 0 ]]; do
  case "$1" in
    --prompt-file)
      [[ $# -ge 2 ]] || err "--prompt-file requires a path argument"
      PROMPT_FILE="$2"
      shift 2
      ;;
    -h|--help)
      usage
      ;;
    *)
      # Classify bare args by type, not position.
      # Only ~/... is expanded; ~user/... is not supported (use absolute paths)
      if [[ "$1" == /* || "$1" == ~* || "$1" == ./* || "$1" == */* ]] \
         || [[ -d "$1" ]]; then
        [[ -z "$PROJECT_DIR" ]] || err "ambiguous: two paths provided"
        PROJECT_DIR="$1"
        [[ "$PROJECT_DIR" == ~/* || "$PROJECT_DIR" == "~" ]] && \
          PROJECT_DIR="${PROJECT_DIR/#\~/$operator_home}"
      elif id "$1" >/dev/null 2>&1 && id -nG "$1" 2>/dev/null | grep -qw agents; then
        [[ -z "$AGENT_USER" ]] || err "ambiguous: two agent users provided"
        AGENT_USER="$1"
      else
        err "cannot infer argument: $1"
      fi
      shift
      ;;
  esac
done

[[ -n "$AGENT_USER" ]] || err "Missing agent username"
[[ -n "$PROJECT_DIR" ]] || err "Missing project directory"
[[ -d "$PROJECT_DIR" ]] || err "Project directory does not exist: $PROJECT_DIR"
id "$AGENT_USER" >/dev/null 2>&1 || err "Agent user '$AGENT_USER' does not exist"

if [[ $EUID -ne 0 ]]; then
  exec sudo "$0" "${ORIG_ARGS[@]}"
fi

PROJECT_DIR=$(realpath "$PROJECT_DIR")
PROJECT_NAME=$(basename "$PROJECT_DIR")
MIRROR_DIR="/home/$AGENT_USER/mirrors/$PROJECT_NAME"

[[ -d "$MIRROR_DIR" ]] || err "Mirror does not exist at $MIRROR_DIR, run rovibe assign first"

# Find sync-mirror
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SYNC_MIRROR=""
if [[ -x "$SCRIPT_DIR/sync-mirror" ]]; then
  SYNC_MIRROR="$SCRIPT_DIR/sync-mirror"
elif command -v sync-mirror >/dev/null 2>&1; then
  SYNC_MIRROR="sync-mirror"
else
  err "sync-mirror not found"
fi

# --- Step 1: Initial sync ---
log "Running initial sync..."
"$SYNC_MIRROR" "$PROJECT_DIR" "$MIRROR_DIR"

# --- Step 2: Start fswatch watcher (if available) ---
WATCHER_PID=""

cleanup() {
  if [[ -n "$WATCHER_PID" ]]; then
    log "Stopping file watcher (PID $WATCHER_PID)..."
    kill "$WATCHER_PID" 2>/dev/null || true
    wait "$WATCHER_PID" 2>/dev/null || true
  fi
}
trap cleanup EXIT INT TERM

if command -v fswatch >/dev/null 2>&1; then
  log "Starting fswatch watcher on $PROJECT_DIR..."
  (
    fswatch -r -e '\.git' -e '\.scratch' "$PROJECT_DIR" | while read -r _; do
      "$SYNC_MIRROR" "$PROJECT_DIR" "$MIRROR_DIR" 2>/dev/null || true
    done
  ) &
  WATCHER_PID=$!
  log "Watcher started (PID $WATCHER_PID)"
else
  log "WARN: fswatch not installed, live sync disabled."
  log "  Files added to the project after launch will not appear in the mirror."
  log "  Run sync-mirror manually to update, or install fswatch."
fi

# --- Step 3: Find claude command ---
CLAUDE_CMD=""

# 1. Direct PATH lookup (works if installed system-wide)
if command -v claude >/dev/null 2>&1; then
  CLAUDE_CMD="$(command -v claude)"

# 2. User-local Claude Code install (most common)
elif [[ -x "$HOME/.claude/local/claude" ]]; then
  CLAUDE_CMD="$HOME/.claude/local/claude"

# 3. Operator's home dir (when launched via sudo, HOME may be root's)
elif [[ -n "${SUDO_USER:-}" && -x "/home/$SUDO_USER/.claude/local/claude" ]]; then
  CLAUDE_CMD="/home/$SUDO_USER/.claude/local/claude"

else
  err "'claude' not found. Install Claude Code: https://docs.anthropic.com/claude-code"
fi

# --- Step 3b: Generate/update AppArmor profile ---
if apparmor_available; then
  apparmor_generate_profile "$AGENT_USER"
  log "AppArmor profile loaded: rovibe-$AGENT_USER"
else
  log "WARN: AppArmor not available, execution sandboxing disabled"
fi

# --- Step 4: Launch Claude Code as agent user ---
log "Launching $CLAUDE_CMD as '$AGENT_USER' in $MIRROR_DIR..."

CLAUDE_ARGS=()
if [[ -n "$PROMPT_FILE" ]]; then
  [[ -f "$PROMPT_FILE" ]] || err "Prompt file not found: $PROMPT_FILE"
  PROMPT_CONTENT=$(<"$PROMPT_FILE")
  CLAUDE_ARGS+=(--print "$PROMPT_CONTENT")
fi

if apparmor_available; then
  sudo -u "$AGENT_USER" aa-exec -p "rovibe-$AGENT_USER" -- \
    bash --login -c \
    'cd "$1" && shift && exec "$@"' \
    -- "$MIRROR_DIR" "$CLAUDE_CMD" ${CLAUDE_ARGS[@]+"${CLAUDE_ARGS[@]}"}
else
  sudo -u "$AGENT_USER" bash --login -c \
    'cd "$1" && shift && exec "$@"' \
    -- "$MIRROR_DIR" "$CLAUDE_CMD" ${CLAUDE_ARGS[@]+"${CLAUDE_ARGS[@]}"}
fi

log "Agent session ended."
